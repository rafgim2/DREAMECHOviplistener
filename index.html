<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>DreamEcho - Oyente</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/midi-writer-js@2.0.5/build/MidiWriter.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      text-align: center;
    }

    h1 {
      font-size: 3em;
      margin-bottom: 0.2em;
    }

    #recuentoOyentes {
      font-size: 1.2em;
      margin-bottom: 0.5em;
      color: #555;
    }

    button {
      margin: 0.5em;
      font-size: 2em;
      padding: 1em 2em;
      cursor: pointer;
    }

    #status {
      margin-bottom: 1em;
      font-size: 1.2em;
    }

    #midiSelectContainer {
      margin-top: 1em;
    }

    #grabacionControles {
      margin-top: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5em;
    }

    #grabacionesSelect {
      font-size: 1em;
      padding: 0.5em;
      margin: 0.5em;
    }

    button.grabando {
      animation: parpadeo 1s infinite;
      background-color: red;
      color: white;
    }

    @keyframes parpadeo {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>DreamEcho - Oyente VIP</h1>
  <p id="recuentoOyentes">Oyentes conectados: --</p>
  <p id="status">Esperando conexi√≥n‚Ä¶</p>

  <button onclick="modoMIDI()">üé∫ Usar mi piano digital</button>
  <button onclick="modoVirtual()">üéß Escuchar con sonido virtual</button>

  <div id="midiSelectContainer"></div>

  <div id="grabacionControles">
    <button id="btnGrabar" onclick="iniciarGrabacion()">‚è∫Ô∏è Grabar</button>
    <button onclick="detenerGrabacion()">‚èπÔ∏è Detener</button>
    <select id="grabacionesSelect">
      <option value="">-- Elige una grabaci√≥n --</option>
    </select>
    <button onclick="reproducirGrabacion()">‚ñ∂Ô∏è Reproducir</button>
    <button onclick="borrarGrabacion()">üóëÔ∏è Borrar</button>
    <button onclick="renombrarGrabacion()">‚úèÔ∏è Renombrar</button>
    <button onclick="descargarGrabacion()">üíæ Descargar .mid</button>
  </div>

  <script>
    const oyentesEl = document.getElementById("recuentoOyentes");
    let ultimaCantidad = null;

    setInterval(() => {
      fetch("/stats")
        .then(res => res.json())
        .then(data => {
          if (data.clients !== ultimaCantidad) {
            oyentesEl.textContent = `Oyentes conectados: ${data.clients}`;
            ultimaCantidad = data.clients;
          }
        })
        .catch(err => console.error("Error obteniendo stats:", err));
    }, 5000);
  </script>
</body>
</html>
