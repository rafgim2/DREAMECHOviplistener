<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>DreamEcho - Oyente VIP</n  </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/midi-writer-js@2.0.5/build/MidiWriter.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      text-align: center;
    }
    h1 {
      font-size: 3em;
      margin-bottom: 0.2em;
    }
    #recuentoOyentes {
      font-size: 1.2em;
      margin-bottom: 0.5em;
      color: #555;
    }
    button {
      font-size: 2em;
      padding: 1em 2em;
      cursor: pointer;
    }
    #status {
      margin-bottom: 1em;
      font-size: 1.2em;
    }
    #midiSelectContainer {
      margin-top: 1em;
    }

    /* Grabaci√≥n: dividir izquierda y derecha */
    #grabacionControles {
      margin-top: 2em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .left-controls,
    .right-controls {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
    }

    #grabacionesSelect {
      font-size: 1em;
      padding: 0.5em;
    }
    button.grabando {
      animation: parpadeo 1s infinite;
      background-color: red;
      color: white;
    }
    @keyframes parpadeo {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    /* Chat */
    #chatControles {
      margin-top: 2em;
      width: 90%;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    #chatLog {
      width: 100%;
      height: 200px;
      padding: 0.5em;
      border: 1px solid #ccc;
      overflow-y: auto;
      background: #fafafa;
      border-radius: 0.5em;
    }
    #chatInput {
      width: 70%;
      padding: 0.5em;
      font-size: 1em;
    }
    #sendChatBtn {
      padding: 0.6em 1em;
      font-size: 1em;
      cursor: pointer;
      margin-left: 0.5em;
    }
  </style>
</head>
<body>
  <h1>DreamEcho - Oyente VIP</h1>
  <p id="recuentoOyentes">Oyentes conectados: --</p>
  <p id="status">Esperando conexi√≥n‚Ä¶</p>

  <button onclick="modoMIDI()">üéπ Usar mi piano digital</button>
  <button onclick="modoVirtual()">üéß Escuchar con sonido virtual</button>

  <div id="midiSelectContainer"></div>

  <!-- Chat justo debajo de la elecci√≥n de modo -->
  <div id="chatControles">
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Escribe tu mensaje‚Ä¶" />
    <button id="sendChatBtn">üó®Ô∏è Enviar</button>
  </div>

  <!-- Controles de grabaci√≥n reordenados -->
  <div id="grabacionControles">
    <div class="left-controls">
      <button id="btnGrabar" onclick="iniciarGrabacion()">‚è∫Ô∏è Grabar</button>
      <button onclick="detenerGrabacion()">‚èπÔ∏è Detener</button>
    </div>
    <div class="right-controls">
      <select id="grabacionesSelect">
        <option value="">-- Elige una grabaci√≥n --</option>
      </select>
      <button onclick="reproducirGrabacion()">‚ñ∂Ô∏è Reproducir</button>
      <button onclick="borrarGrabacion()">üóëÔ∏è Borrar</button>
      <button onclick="renombrarGrabacion()">‚úèÔ∏è Renombrar</button>
      <button onclick="descargarGrabacion()">üíæ Descargar .mid</button>
    </div>
  </div>

  <script>
    // Elementos clave
    const statusEl = document.getElementById("status");
    const oyentesEl = document.getElementById("recuentoOyentes");
    const midiSelectContainer = document.getElementById("midiSelectContainer");
    const grabacionesSelect = document.getElementById("grabacionesSelect");
    const btnGrabar = document.getElementById("btnGrabar");
    const chatLog = document.getElementById("chatLog");
    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChatBtn");

    // WebSocket
    const ws = new WebSocket("wss://dreamecho.onrender.com");

    // Variables MIDI y grabaci√≥n
    let output = null, modo = null, synth = null, pedal = false;
    let baseTime = null, queuePos = 0, queueLatency = 100;
    const notasActivas = new Set(), notasSostenidas = new Set();
    let grabando = false, grabacionActual = [], grabaciones = [];
    let primeraEstadisticaMostrada = false;

    // Nombre usuario chat
    const username = prompt("¬øC√≥mo quieres que te vean en el chat?", "Oyente") || "Oyente";

    function appendChat(user, text) {
      const msg = document.createElement("div");
      const time = new Date().toLocaleTimeString();
      msg.innerHTML = `<small>[${time}]</small> <strong>${user}:</strong> ${text}`;
      chatLog.appendChild(msg);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function sendChat() {
      const text = chatInput.value.trim();
      if (!text || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: "chat", user: username, text }));
      chatInput.value = "";
    }

    sendChatBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendChat();
    });

    ws.onopen = () => {
      statusEl.textContent = "Conectado al servidor, esperando tu elecci√≥n‚Ä¶";
    };

    ws.onmessage = async event => {
      const raw = typeof event.data === "string" ? event.data : await event.data.text();
      const msg = JSON.parse(raw);

      if (msg.type === "stats") {
        oyentesEl.textContent = `Oyentes conectados: ${msg.clients}`;
        if (!primeraEstadisticaMostrada) {
          queuePos = msg.clients;
          queueLatency = 50 + 5 * Math.sqrt(queuePos);
          statusEl.textContent =
            `Posici√≥n en cola: ${queuePos} ‚Üí latencia = ${Math.round(queueLatency)} ms`;
          primeraEstadisticaMostrada = true;
        }
        return;
      }

      if (msg.type === "chat") {
        appendChat(msg.user, msg.text);
        return;
      }

      if (msg.type === "midi") {
        const [st, note, velocity] = msg.data;
        const command = st & 0xf0;
        const eventTime = msg.time;
        if (!baseTime) baseTime = performance.now() - eventTime;
        const extra = modo === "virtual" ? queueLatency : 0;
        const delay = Math.max(
          0,
          eventTime + baseTime - performance.now() + extra
        );
        const toneTime = "+" + (delay / 1000);

        if (grabando) {
          grabacionActual.push({ data: msg.data, time: performance.now() });
        }

        if (modo === "midi" && output) {
          return setTimeout(
            () => output.send(new Uint8Array(msg.data)),
            delay
          );
        }

        if (modo === "virtual" && synth) {
          const freq = Tone.Frequency(note, "midi").toFrequency();
          if (command === 0x90 && velocity > 0) {
            if (!notasActivas.has(freq)) {
              Tone.Draw.schedule(() =>
                synth.triggerAttack(freq, undefined, velocity/127), toneTime
              );
            }
            notasActivas.add(freq);
            notasSostenidas.delete(freq);
          } else if (command === 0x80 || (command === 0x90 && velocity===0)) {
            if (pedal) {
              notasActivas.delete(freq);
              notasSostenidas.add(freq);
            } else {
              Tone.Draw.schedule(() =>
                synth.triggerRelease(freq, "+0.2"), toneTime
              );
              notasActivas.delete(freq);
              notasSostenidas.delete(freq);
            }
          } else if (st===176 && note===64) {
            pedal = velocity>=64;
            if (!pedal) {
              Tone.Draw.schedule(() => {
                for (let f of [...notasSostenidas]) {
                  if (!notasActivas.has(f)) {
                    synth.triggerRelease(f, "+0.2");
                    notasSostenidas.delete(f);
                  }
                }
              }, toneTime);
            }
          }
        }
      }
    };

    function modoMIDI() {
      modo = "midi";
      statusEl.innerText = "Buscando dispositivos MIDI de salida‚Ä¶";
      navigator.requestMIDIAccess().then(midiAccess => {
        const outputs = Array.from(midiAccess.outputs.values());
        if (outputs.length) {
          midiSelectContainer.innerHTML = "";
          const sel = document.createElement("select");
          sel.id = "midiOutSelect";
          const dopt = document.createElement("option");
          dopt.text = "-- Elige dispositivo MIDI --";
          dopt.value = "";
          sel.appendChild(dopt);
          outputs.forEach((o,i) => {
            const opt = document.createElement("option");
            opt.value = o.id;
            opt.text = o.name||`MIDI Dispositivo ${i+1}`;
            sel.appendChild(opt);
          });
          sel.addEventListener("change", e => {
            const chosen = outputs.find(o=>o.id===e.target.value);
            if (chosen) {
              output=chosen;
              statusEl.innerText=`Salida MIDI seleccionada: ${chosen.name}`;
            } else {
              statusEl.innerText="No se ha seleccionado salida MIDI.";
              output=null;
            }
          });
          midiSelectContainer.appendChild(sel);
          statusEl.innerText="Selecciona un dispositivo MIDI para usarlo.";
        } else {
          statusEl.innerText="No se han encontrado salidas MIDI.";
        }
      }).catch(() => {
        statusEl.innerText="No se ha podido acceder a WebMIDI.";
      });
    }

    async function modoVirtual() {
      modo="virtual";
      statusEl.innerText="Cargando piano virtual‚Ä¶";
      await Tone.start();
      synth=new Tone.Sampler({
        urls:{
          A0:"A0.mp3",C1:"C1.mp3","D#1":"Ds1.mp3","F#1":"Fs1.mp3",
          A1:"A1.mp3",C2:"C2.mp3","D#2":"Ds2.mp3","F#2":"Fs2.mp3",
          A2:"A2.mp3",C3:"C3.mp3","D#3":"Ds3.mp3","F#3":"Fs3.mp3",
          A3:"A3.mp3",C4:"C4.mp3","D#4":"Ds4.mp3","F#4":"Fs4.mp3",
          A4:"A4.mp3",C5:"C5.mp3","D#5":"Ds5.mp3","F#5":"Fs5.mp3",
          A5:"A5.mp3",C6:"C6.mp3","D#6":"Ds6.mp3","F#6":"Fs6.mp3",
          A7:"A7.mp3",C8:"C8.mp3"
        },
        baseUrl:"https://tonejs.github.io/audio/salamander/",
        release:0.4,
        onload:() => {
          statusEl.innerText=
            `Modo virtual listo. Posici√≥n en cola: ${queuePos} (latencia ‚âÉ ${Math.round(queueLatency)} ms)`;
        }
      }).toDestination();
    }
  </script>
</body>
</html>
